<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | DPC Solutions</title>
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            background: #0f141a;
            color: #eee;
        }

        .admin-header {
            background: rgba(5, 10, 16, 0.95);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }

        .sidebar {
            position: sticky;
            top: 6rem;
            height: fit-content;
        }

        .nav-tabs {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: block;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            background: var(--bg-card);
            padding: 1rem;
            /* Reduced padding for cleaner look */
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Array Item container */
        .array-item {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            position: relative;
        }

        .array-item-title {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--bg-card);
            padding: 0 10px;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .editor-container {
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }

        .ql-toolbar {
            background: #eee;
            color: black;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .ql-container {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            font-family: inherit;
        }

        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(5, 10, 16, 0.95);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            z-index: 999;
        }
    </style>
</head>

<body>

    <header class="admin-header">
        <div class="logo" style="display:flex; align-items:center; gap:10px;">
            <img src="/images/logo.png" style="height:30px;">
            <span style="font-weight:bold;">CMS</span>
        </div>
        <div class="user-actions">
            <a href="/" target="_blank" class="btn btn-outline" style="margin-right:1rem;">View Site</a>
            <a href="/admin/logout" class="btn btn-outline">Logout</a>
        </div>
    </header>

    <div class="admin-container">
        <aside class="sidebar">
            <ul class="nav-tabs">
                <li class="nav-item"><span class="nav-link active" onclick="showTab('hero')">Hero Section</span></li>
                <li class="nav-item"><span class="nav-link" onclick="showTab('about')">About Section</span></li>
                <li class="nav-item"><span class="nav-link" onclick="showTab('services')">Services</span></li>
                <li class="nav-item"><span class="nav-link" onclick="showTab('team')">Team</span></li>
                <li class="nav-item"><span class="nav-link" onclick="showTab('contact')">Contact Us</span></li>
            </ul>
        </aside>

        <main class="content-area">
            <form id="contentForm">

                <!-- Hero Tab -->
                <div id="hero" class="tab-pane active">
                    <div class="tab-content">
                        <h2>Hero Section</h2>
                        <div class="form-group">
                            <label class="form-label">Tagline</label>
                            <input type="text" name="hero.tagline" class="form-control"
                                value="<%= content.hero.tagline %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title Line 1</label>
                            <input type="text" name="hero.title_line_1" class="form-control"
                                value="<%= content.hero.title_line_1 %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title Line 2 (Gradient)</label>
                            <input type="text" name="hero.title_line_2" class="form-control"
                                value="<%= content.hero.title_line_2 %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title Line 3</label>
                            <input type="text" name="hero.title_line_3" class="form-control"
                                value="<%= content.hero.title_line_3 %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <textarea name="hero.subtitle" class="form-control"
                                rows="3"><%= content.hero.subtitle %></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Text</label>
                            <input type="text" name="hero.button_text" class="form-control"
                                value="<%= content.hero.button_text %>">
                        </div>
                    </div>
                </div>

                <!-- About Tab -->
                <div id="about" class="tab-pane">
                    <div class="tab-content">
                        <h2>About Section</h2>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" name="about.title" class="form-control"
                                value="<%= content.about.title %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lead Text</label>
                            <textarea name="about.lead_text" class="form-control"
                                rows="3"><%= content.about.lead_text %></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Body Text</label>
                            <textarea name="about.body_text" class="form-control"
                                rows="5"><%= content.about.body_text %></textarea>
                        </div>

                        <h3>Core Values</h3>
                        <% content.about.values.forEach((val, i)=> { %>
                            <div class="form-group">
                                <label class="form-label">Value <%= i + 1 %></label>
                                <input type="text" name="about.values[<%= i %>]" class="form-control"
                                    value="<%= val %>">
                            </div>
                            <% }) %>
                    </div>
                </div>

                <!-- Services Tab -->
                <div id="services" class="tab-pane">
                    <div class="tab-content">
                        <h2>Services</h2>
                        <% content.services.forEach((service, i)=> { %>
                            <div class="array-item">
                                <span class="array-item-title">
                                    <%= service.title %>
                                </span>
                                <input type="hidden" name="services[<%= i %>].id" value="<%= service.id %>">

                                <div class="form-group">
                                    <label class="form-label">Title</label>
                                    <input type="text" name="services[<%= i %>].title" class="form-control"
                                        value="<%= service.title %>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea name="services[<%= i %>].description" class="form-control"
                                        rows="3"><%= service.description %></textarea>
                                </div>

                                <label class="form-label">Key Capabilities (Bulleted)</label>
                                <% service.details.forEach((detail, j)=> { %>
                                    <div class="form-group"
                                        style="padding-left:1rem; border-left:2px solid var(--border-color);">
                                        <input type="text" name="services[<%= i %>].details[<%= j %>]"
                                            class="form-control" value="<%= detail %>">
                                    </div>
                                    <% }) %>
                            </div>
                            <% }) %>
                    </div>
                </div>

                <!-- Team Tab -->
                <div id="team" class="tab-pane">
                    <div class="tab-content">
                        <h2>Team</h2>
                        <% content.team.forEach((member, i)=> { %>
                            <div class="array-item">
                                <span class="array-item-title">
                                    <%= member.name %>
                                </span>
                                <input type="hidden" name="team[<%= i %>].id" value="<%= member.id %>">

                                <div class="form-group">
                                    <label class="form-label">Name</label>
                                    <input type="text" name="team[<%= i %>].name" class="form-control"
                                        value="<%= member.name %>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Role</label>
                                    <input type="text" name="team[<%= i %>].role" class="form-control"
                                        value="<%= member.role %>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bio</label>
                                    <textarea name="team[<%= i %>].bio" class="form-control"
                                        rows="4"><%= member.bio %></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="text" name="team[<%= i %>].email" class="form-control"
                                        value="<%= member.email %>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="text" name="team[<%= i %>].phone" class="form-control"
                                        value="<%= member.phone %>">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">LinkedIn URL</label>
                                    <input type="text" name="team[<%= i %>].linkedin" class="form-control"
                                        value="<%= member.linkedin || '' %>">
                                </div>
                            </div>
                            <% }) %>
                    </div>
                </div>

                <!-- Contact Tab -->
                <div id="contact" class="tab-pane">
                    <div class="tab-content">
                        <h2>Contact Us</h2>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" name="contact.title" class="form-control"
                                value="<%= content.contact.title %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea name="contact.description" class="form-control"
                                rows="3"><%= content.contact.description %></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Email</label>
                            <input type="text" name="contact.email" class="form-control"
                                value="<%= content.contact.email %>">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Phone</label>
                            <input type="text" name="contact.phone" class="form-control"
                                value="<%= content.contact.phone %>">
                        </div>
                    </div>
                </div>

            </form>
        </main>
    </div>

    <div class="save-bar">
        <span id="saveStatus" style="color:var(--secondary); align-self:center; margin-right:1rem; display:none;">Saved
            Successfully!</span>
        <button type="button" onclick="saveContent()" class="btn btn-primary">Save Changes</button>
    </div>

    <script>
        function showTab(id) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // Helper to convert form names with brackets/dots into nested object
        // e.g. "hero.tagline" -> {hero: {tagline: val}}
        // "services[0].title" -> {services: [{title: val}]}
        function formToJSON(form) {
            const formData = new FormData(form);
            const obj = {};

            for (let [key, value] of formData.entries()) {
                // Split by dot for basic nesting
                // Only handling simple nesting for this demo script
                // Regex to handle arrays: hero.title or services[0].title

                // We will use a dedicated library usually, but here is a simple recursive setter
                setObjectValue(obj, key, value);
            }
            return obj;
        }

        function setObjectValue(obj, path, value) {
            // Replace brackets with dots: services[0].title -> services.0.title
            const parts = path.replace(/\[(\d+)]/g, '.$1').split('.');

            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                const nextPart = parts[i + 1];

                // If the next part is a number, we need an array
                if (!current[part]) {
                    const isArray = !isNaN(nextPart);
                    current[part] = isArray ? [] : {};
                }
                current = current[part];
            }
            current[parts[parts.length - 1]] = value;
        }

        async function saveContent() {
            const form = document.getElementById('contentForm');
            const data = formToJSON(form);

            const btn = document.querySelector('.save-bar .btn');
            const status = document.getElementById('saveStatus');

            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const res = await fetch('/admin/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    status.style.display = 'block';
                    status.style.color = '#4ade80'; // success green
                    status.textContent = 'Saved Successfully!';
                    setTimeout(() => status.style.display = 'none', 3000);
                } else {
                    status.style.display = 'block';
                    status.style.color = '#ff6b6b';
                    status.textContent = 'Error saving.';
                }
            } catch (e) {
                console.error(e);
                status.style.display = 'block';
                status.style.color = '#ff6b6b';
                status.textContent = 'Network Error.';
            }

            btn.textContent = 'Save Changes';
            btn.disabled = false;
        }
    </script>
</body>

</html>